<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title></title>
<link crossorigin="anonymous" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
  integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js"></script>
<style type="text/css">
  /* Base styles */
  /* Base styles */
  /* Base styles */
  body {
    font-family: 'Open Sans', sans-serif;
    font-size: 0.875rem;
  }

  .container-fluid {
    max-width: 1920px;
    margin: 15px auto;
  }

  /* Chart header styles */
  .chart-header {
    display: flex;
    align-items: flex-start;
  }

  .chart-header-icon {
    width: 36px;
    height: 36px;
    margin-top: 4px;
    margin-right: 8px;
  }

  @media (max-width: 768px) {
    .chart-header-icon {
      display: none;
    }

    .chart-header {
      align-items: flex-start;
    }
  }

  .chart-title-main {
    font-size: 1rem;
    color: #00aaff;
    font-weight: bold;
  }

  .chart-title-main span {
    font-weight: normal;
    font-style: italic;
  }

  .chart-title-sub,
  .chart-footer {
    font-size: 0.75rem;
    color: #6c757d;
  }

  /* Button styles */
  #buttons {
    display: flex;
    justify-content: flex-end;
  }

  @media (max-width: 768px) {
    #buttons {
      display: none !important;
    }
  }

  .btn__svg {
    text-align: left;
    text-indent: -9999px;
    font-size: 0;
    line-height: 0px;
    background-position: center center;
    background-repeat: no-repeat;
    background-size: contain;
    border: 0;
    background-color: transparent;
    height: 36px;
    width: 30px;
    padding: 0;
    margin-right: 5px;
    position: relative;
  }

  .btn__svg:hover::after {
    opacity: 1;
  }

  .btn__svg::after {
    background-position: center center;
    background-repeat: no-repeat;
    background-size: contain;
    content: "";
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 0.1s cubic-bezier(0.3, 0.65, 0.72, 0.63);
    background-color: #fff;
  }

  /* Button specific images */
  .btn__export--pdf {
    background-image: url(https://www.lhfatlas.org.uk/sites/default/files/images/pdf-black.png);
  }

  .btn__export--pdf::after {
    background-image: url(https://www.lhfatlas.org.uk/sites/default/files/images/pdf-blue.png);
  }

  .btn__export--csv {
    background-image: url(https://www.lhfatlas.org.uk/sites/default/files/images/csv-black.png);
  }

  .btn__export--csv::after {
    background-image: url(https://www.lhfatlas.org.uk/sites/default/files/images/csv-blue.png);
  }

  .btn__copy {
    background-image: url(https://www.lhfatlas.org.uk/sites/default/files/images/url-black.png);
  }

  .btn__copy::after {
    background-image: url(https://www.lhfatlas.org.uk/sites/default/files/images/url-blue.png);
  }

  /* Tooltip styles */
  .chart-tooltip {
    position: fixed;
    top: 0;
    left: 0;
    pointer-events: none;
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 0, 0, 0.125);
    border-radius: 0.25rem;
    padding: 0.75rem 1.25rem;
    max-width: 100vw;
    opacity: 0;
    transition: opacity 0.15s linear;
  }

  @media (max-width: 768px) {
    .chart-tooltip {
      pointer-events: auto;
      padding-top: 2rem;
    }
  }

  .tooltip-close {
    display: none;
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: none;
    border: none;
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
    color: #6c757d;
    padding: 0;
    width: 1.5rem;
    height: 1.5rem;
  }

  @media (max-width: 768px) {
    .tooltip-close {
      display: block;
    }
  }

  .tooltip-link {
    display: none;
    margin-top: 0.5rem;
    color: #00aaff;
    text-decoration: underline;
    cursor: pointer;
  }

  @media (max-width: 768px) {
    .tooltip-link {
      display: block;
    }
  }

  .chart-tooltip p {
    margin-bottom: 0.5rem;
  }

  .chart-tooltip p:last-of-type {
    margin-bottom: 0;
  }

  .chart-tooltip.show {
    opacity: 1;
  }

  .chart-tooltip .service-name {
    font-size: 1rem;
    font-weight: bold;
    color: #00aaff;
  }

  .chart-tooltip .service-capacity {
    color: #ff4e80;
    font-weight: bold;
  }

  .chart-tooltip span {
    color: #4e79a8;
  }

  /* Chart and Infographic styles */
  .chart-container,
  .infographic-chart {
    position: relative;
  }

  .infographic-summary {
    max-width: 350px;
    margin-left: auto;
    margin-top: -100px;
  }

  @media (max-width: 768px) {
    .infographic-summary {
      margin-top: 0;
      margin-left: 0;
      max-width: 100%;
    }
  }

  .infographic-summary .summary-title {
    font-size: 1rem;
    font-weight: bold;
    margin-bottom: 0.75rem;
    text-align: left;
  }

  .infographic-summary .summary-row {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    margin-bottom: 0.5rem;
    gap: 0 !important;
  }

  .infographic-summary .summary-row .color-square {
    flex-shrink: 0 !important;
    flex-grow: 0 !important;
    width: 12px !important;
    height: 12px !important;
    min-width: 12px !important;
    margin-right: 10px !important;
    margin-top: 0 !important;
    margin-left: 0 !important;
    margin-bottom: 0 !important;
    display: block !important;
    order: 1 !important;
    align-self: center !important;
  }

  .infographic-summary .summary-row > div:last-child {
    flex: 1 !important;
    text-align: left !important;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.4;
    display: block !important;
    order: 2 !important;
    align-self: center !important;
  }

  .infographic-summary span {
    font-size: 1.25rem;
    font-weight: bold;
  }

  /* Block styles */
  .infographic-chart .block {
    stroke-width: 1;
    stroke: #fff;
  }

  .infographic-chart .block:hover {
    stroke-width: 2;
    stroke: #000;
  }

  /* Pan London styles */
  .pan-london-container {
    width: 100%;
    margin-top: 1rem;
  }

  @media (max-width: 768px) {
    .pan-london-container {
      margin-top: 2rem;
    }
  }

  .pan-london-label {
    color: #00aaff;
    font-weight: bold;
    line-height: 1.1;
  }

  @media (max-width: 768px) {
    .pan-london-label {
      margin-bottom: 0.25rem;
      display: flex;
      justify-content: space-between;
    }
  }

  .pan-london-svg {
    display: block;
    width: 100%;
    height: 120px;
  }

  @media (max-width: 768px) {
    .pan-london-svg {
      width: auto !important;
      height: auto !important;
    }
  }

  /* Embedded content styles */
  .my-embedded-content {
    padding: 3px !important;
  }

  /* Mobile-first Layout (below 1200px) */
  .infographic-chart {
    display: flex;
    flex-direction: column;
  }

  .infographic-chart-row {
    width: 100%;
    margin-bottom: 30px !important;
    display: flex !important;
    flex-direction: column !important;
    /* Stack label above blocks on mobile */
  }

  .label-col {
    width: 100% !important;
    padding: 0 !important;
    margin-bottom: 0.25rem !important;
    display: flex;
    justify-content: space-between;
    max-width: none !important;
  }

  .label-col .row-total::after {
    content: " services";
  }

  .blocks-col {
    width: 100% !important;
    padding: 0 !important;
    line-height: 0;
    max-width: none !important;
  }

  .blocks-col svg {
    width: 100% !important;
    height: auto !important;
  }

  /* Hide "Number of services" text on mobile */
  @media (max-width: 768px) {
    .infographic-chart-header-unit {
      display: none !important;
    }
  }

  /* Stack order for mobile */
  .infographic-summary {
    order: 1;
    width: 100%;
    margin-bottom: 1rem;
  }

  #infographic-chart {
    order: 2;
  }

  .pan-london-container {
    order: 3;
  }

  /* Desktop Layout (1200px and above) */
  /* Base mobile styles */
  .chart-container {
    position: relative;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    /* Give enough room for all elements */
  }

  /* Mobile layout ordering and spacing */
  @media (max-width: 1199px) {
    .infographic-summary {
      position: static !important;
      order: 1;
      margin-bottom: 2rem;
      width: 100%;
    }

    #infographic-chart {
      position: static !important;
      order: 2;
      margin-bottom: 2rem;
      width: 100%;
    }

    .pan-london-container {
      position: static !important;
      order: 3;
      width: 100%;
      margin-top: 2rem;
    }

    /* Right align borough names in mobile */
    .infographic-chart-row .label-col {
      text-align: left;
    }

    .infographic-chart-row .label-col .row-name {
      text-align: left;
    }
  }

  /* Desktop layout */
  @media (min-width: 769px) {
    .infographic-chart-row {
      flex-direction: row !important;
      flex-wrap: nowrap !important;
      align-items: center !important;
      margin-bottom: 0.25rem !important;
    }

    .infographic-chart-row .label-col {
      width: 240px !important;
      min-width: 240px !important;
      flex: 0 0 240px !important;
      max-width: 240px !important;
      margin-bottom: 0 !important;
      padding-right: 15px !important;
    }

    .infographic-chart-row .blocks-col {
      flex: 1 1 auto !important;
      width: auto !important;
      max-width: none !important;
    }

    .label-col .row-total::after {
      content: "" !important;
    }
  }

    .infographic-summary {
      position: absolute;
      right: 0;
      top: 400px;
      bottom: auto;
      width: auto;
    }

    .pan-london-container {
      position: absolute;
      left: 50%;
      bottom: 10%;
      width: 120px;
    }
  }

  .label-col {
    width: 240px;
    flex-shrink: 0;
  }

  .blocks-col {
    flex-grow: 1;
  }

  .infographic-summary {
    position: absolute;
    right: 0;
    bottom: 0;
    width: auto;
    text-align: right;
  }

  .pan-london-container {
    position: absolute;
    left: 50%;
    bottom: 10%;
    width: 120px;
  }


  /* Media query adjustments */
  @media (min-width: 600px) {
    .chart-tooltip {
      max-width: 600px;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .chart-tooltip {
      transition: none;
    }
  }

  /* Modal backdrop */
  .modal-backdrop.show {
    opacity: 0.2;
  }

  /* Utility classes */
  .d-flex {
    display: flex;
  }

  .justify-content-between {
    justify-content: space-between;
  }

  .align-items-center {
    align-items: center;
  }

  .color-square {
    display: inline-block;
    width: 12px;
    height: 12px;
    margin-right: 8px;
    border: 1px solid #ddd;
  }

  .summary-row {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
    float: right;
    /* Add this to right-align the whole row */
    clear: both;
    /* Ensure rows stack properly */
  }

  .summary-title {
    text-align: right;
    /* Right align the title too */
  }

  /* Override for infographic summary - left aligned layout */
  .infographic-summary .summary-title {
    float: none !important;
    clear: none !important;
    text-align: left !important;
  }

  .infographic-summary .summary-row {
    float: none !important;
    clear: none !important;
    align-items: flex-start !important;
  }
</style>
<div class="my-embedded-content">
  <div class="container-fluid px-sm-5">
    <div class="alert alert-danger d-none" role="alert">Failed to retrieve the data. Please try again later.</div>

    <div class="row control-row">
      <div class="col-12 col-lg-3" style="padding-top:3px; padding-bottom:3px">
        <div class="form-group"><label for="group-by-select">Group by borough or provider?</label> <select
            class="form-control custom-select custom-select-sm" id="group-by-select">
            <option value="borough">Borough</option>
            <option value="provider">Provider</option>
          </select></div>
      </div>

      <div class="col-12 col-lg-3" style="padding-top:3px; padding-bottom:3px">
        <div class="form-group"><label for="size-by-select">Focus on accommodation?</label> <select
            class="form-control custom-select custom-select-sm" id="size-by-select">
            <option value="service">No - Show all types of services</option>
            <option value="bed">Yes - Show accommodation by size</option>
          </select></div>
      </div>
      <div class="col-12 col-lg-3" style="padding-top:3px; padding-bottom:3px">
        <div class="form-group">
          <label for="include-yp-select">Include accommodation for young people?</label>
          <select class="form-control custom-select custom-select-sm" id="include-yp-select">
            <option value="yes">Yes - Show all accommodation</option>
            <option value="no">No - Only show rough sleeping/single homelessness accommodation</option>
          </select>
        </div>
      </div>
      <div class="col-12 col-lg-3" style="padding-top:3px; padding-bottom:3px; display:none">
        <div class="form-group"><label for="highlight-by-select">Highlight specific services:</label> <select
            class="form-control custom-select custom-select-sm" id="highlight-by-select">
            <optgroup label="ALL SERVICES">
              <option value="london">All London</option>
            </optgroup>
            <optgroup label="CLIENT GROUPS">
              <option value="women">Women's services</option>
              <option value="young">Young People's services</option>
            </optgroup>
          </select></div>
      </div>

      <div class="col-12 col-lg-3 d-flex flex-column" style="padding-top:3px; padding-bottom:3px">
        <div class="flex-grow-1">&nbsp;</div>

        <div class="btn-group form-group" id="buttons" style="visibility: visible"><button
            class="btn__export btn__export--pdf btn__svg" onclick="printPDF()" title="Export button label">Export to
            PDF</button>
          <!-- <button class="btn__export btn__export--csv btn__svg">Export Data</button> -->
          <button class="btn__copy btn__svg" onclick="CopyURL()" title="Copy URL label">Copy URL</button>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12" style="padding-top:3px; padding-bottom:3px">
        <div class="chart-header"><img alt="icon" class="chart-header-icon"
            src="https://www.lhfatlas.org.uk/sites/default/files/images/accom_icon.png" />
          <div class="chart-title">
            <div class="chart-title-main">&nbsp;</div>

            <div class="chart-title-sub">Data source: Services data is the latest from Homeless Link information team.
            </div>

            <div class="chart-intro"><span class="hover-text">Hover over</span><span class="click-text" style="display: none;">Click</span> a block for extra information</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12 chart-container" style="padding-top:3px; padding-bottom:3px">
        <div class="mt-3" id="infographic-summary"></div>

        <div class="mt-3" id="infographic-chart"></div>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <div class="chart-footer">Â© LHF Atlas 2025</div>
      </div>
    </div>
  </div>
</div>

<div class="chart-tooltip">&nbsp;</div>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/d3-array.v2.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
  integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
  integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
  integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
<script>
  var params = new URLSearchParams(window.location.search.substring(1));
  function loadData() {
    $(".custom-select").each(function (index) {
      if (params != "") {
        var id = $(this).attr('id');
        var val1 = params.get(id)
        if (!val1) {
          return
        }

        //$('#'+id).val(val1).change();
        var sortBySelect = document.querySelector('#' + id);
        sortBySelect.value = val1;
        sortBySelect.dispatchEvent(new Event("change"));
        d3.select('#' + id).select('option[value="' + val1 + '"]').attr('selected', 'selected');
      }
    });
  }

  $('.custom-select').on('change', function () {

    var parametr = '';

    $(".custom-select").each(function (index) {
      var values = jQuery(this).val(); // get selected value
      var id = $(this).attr('id');
      parametr += "&" + id + "=" + values;

    });

    var query = window.location.search.substring(1);

    // is there anything there ?
    if (query.length) {
      // are the new history methods available ?
      if (window.history != undefined && window.history.pushState != undefined) {
        // if pushstate exists, add a new state to the history, this changes the url without reloading the page

        window.history.pushState({}, document.title, window.location.pathname);

      }
    }
    var location = document.URL + "?" + parametr;
    window.history.replaceState(null, null, location);
    if (window.self !== window.top) { // checking if it is an iframe
      window.parent.postMessage(`{"command" : "updateQuery","value":"${parametr}"}`, '*')
    }
  });

  function CopyURL() {
    window.parent.postMessage(`{"command" : "copyURL"}`, '*')
  }

  function printPDF() {
    let chartRow = document.querySelector('.my-embedded-content');
    if (!chartRow) {
      console.error("Element '.row.chart-row' not found.");
      return;
    }

    html2canvas(chartRow, { useCORS: true }).then(canvas => {
      try {
        let pdf = new jsPDF('l', 'mm', 'a4'); // landscape orientation
        let imgData = canvas.toDataURL('image/png');

        // Adjust the dimensions for landscape
        let pdfWidth = 297; // A4 width in mm
        let pdfHeight = 210; // A4 height in mm
        let imgWidth = canvas.width;
        let imgHeight = canvas.height;
        let ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);

        let newWidth = imgWidth * ratio;
        let newHeight = imgHeight * ratio;
        let xOffset = (pdfWidth - newWidth) / 2;
        let yOffset = (pdfHeight - newHeight) / 2;

        pdf.addImage(imgData, 'PNG', xOffset, yOffset, newWidth, newHeight);
        pdf.save('download.pdf');
      } catch (e) {
        console.error("Error generating PDF: ", e);
      }
    }).catch(error => {
      console.error("Error in html2canvas: ", error);
    });
  }

</script>
<script>
  (function () {
    const SERVICES_URL = "https://raw.githubusercontent.com/illustrating-impact-dev/repo-lhf-atlas/main/services_multirow.json";
    const PROVIDERS_URL = "https://raw.githubusercontent.com/illustrating-impact-dev/repo-lhf-atlas/main/services_singlerow.json";
    const TOTALS_URL = "https://raw.githubusercontent.com/illustrating-impact-dev/repo-lhf-atlas/main/services_borough_summary.json";
    const COLORS_URL = "https://raw.githubusercontent.com/illustrating-impact-dev/repo-lhf-atlas/main/lkp_colours.json";
    const COLORS_URL_G = "https://raw.githubusercontent.com/illustrating-impact-dev/repo-lhf-atlas/main/lkp_colours.json";
    const TRANSITION_DURATION = 750;

    const selected = {
      groupBy: "borough",
      sizeBy: "service",
      highlightBy: "london",
      includeYP: "yes",
    };

    const touchable = isTouchDevice();

    let data;

    const accessor = {
      services: {
        id: (d) => d.id,
        serviceName: (d) => d["LHF Atlas Service Level Name"],
        providerName: (d) => d.Provider,
        providerGroup: {
          service: (d) => d.providerGroupService,
          bed: (d) => d.providerGroupBed,
        },
        recordTypeId: (d) => d["Record Type ID"],
        beds: (d) => d["Total Bed Spaces"],
        highlight: {
          london: () => 1,
          women: (d) => (d["Women's service"] ? 1 : 0),
          young: (d) => (d["Young people's service"] ? 1 : 0),
        },
        borough: (d) => d.la_name,
        website: (d) =>
          d.Website && d.Website.slice(0, 4) !== "http"
            ? `https://${d.Website}`
            : d.Website,
        serviceType: (d) => d.serviceType,
        text: (d) => [d.ServiceText1, d.ServiceText2, d.ServiceText3],
      },
      totals: {
        key: (d) => d.gss,
      },
      colors: {
        infographicRelated: (d) => d.colour_key === 4,
        recordTypeId: (d) => d.colour_value,
        color: (d) => `#${d.colour_hex.slice(0, 6)}`,
        serviceType: (d) => d.note,
      },
    };



    const colorByServiceType = d3.scaleOrdinal();
    const serviceTypeByRecordTypeId = d3.scaleOrdinal().unknown("Unknown");

    const formatCount = d3.format(",");

    const dispatch = d3.dispatch("update");

    // Init
    const alert = setupAlert();
    const tooltip = renderTooltip(d3.select(".chart-tooltip"));

    function updateInstructionText() {
      const isMobile = window.innerWidth <= 768;
      const hoverText = document.querySelector('.hover-text');
      const clickText = document.querySelector('.click-text');
      if (hoverText && clickText) {
        if (isMobile) {
          hoverText.style.display = 'none';
          clickText.style.display = 'inline';
        } else {
          hoverText.style.display = 'inline';
          clickText.style.display = 'none';
        }
      }

      // Update dropdown text for mobile
      const sizeBySelect = document.querySelector('#size-by-select');
      if (sizeBySelect) {
        const bedOption = sizeBySelect.querySelector('option[value="bed"]');
        if (bedOption) {
          if (isMobile) {
            bedOption.textContent = 'Yes - Show only accommodation';
          } else {
            bedOption.textContent = 'Yes - Show accommodation by size';
          }
        }
      }
    }

    function extractValues(response, func) {
      return response.feed.entry.map(d => {
        const prefix = 'gsx$';
        const keys = Object.keys(d).filter(k => k.startsWith(prefix)).map(k => k.replace(prefix, ''));
        const entry = {};
        keys.forEach(k => {
          entry[k] = d[prefix + k]['$t']
        })
        return entry
      }).map(func);
    }

    const bools = {
      "false": false,
      "true": true
    }
    const servicesFunc = function (d) {
      delete d.columns
      d = d3.autoType(d);
      return {
        ...d,
        serviceType: d["service_type"],
        "Record Type ID": d["id"],
        "la_name": d["laname"],
        "LHF Atlas Service Level Name": d["service"],
        "mb": d["mb"] ? bools[d["mb"].toLowerCase()] : false,
        "women": d["women"] ? bools[d["women"].toLowerCase()] : false,
        "yp": d["yp"] ? bools[d["yp"].toLowerCase()] : false
      }
    }

    Promise.all([
      d3.json(SERVICES_URL),
      d3.json(PROVIDERS_URL),
      d3.json(TOTALS_URL),
      d3.json(COLORS_URL_G)
    ])
      .then(([servicesData, providersData, totalsData, colorsData]) => {
        // Transform servicesData
        let services = servicesData.map(d => ({
          "LHF Atlas Service Level Name": d["service"],
          "Provider": d["Provider"],
          "Provider1or2": d["Provider"],
          "Record Type ID": d["Id"],
          "ServiceText1": d["service_text_1"],
          "ServiceText2": d["service_text_2"],
          "ServiceText3": d["service_text_3"],
          "Total Bed Spaces": +d["beds"],
          "Women's service": d["women"],
          "Website": d["URL_link"],
          "Young people's service": d["yp"],
          "Shelter": +d["shelter"],
          "geo_code": d["GSS_Code_list__c"],
          "la_name": d["la_name"],
          "serviceType": d['service_type']
        }));

        // Transform providersData
        let providers = providersData.map(d => ({
          "LHF Atlas Service Level Name": d["service_name"],
          "Provider": d["service_provider"],
          "Provider1or2": d["service_provider"],
          "Record Type ID": d["record_type_id"],
          "ServiceText1": d["service_text_1"],
          "ServiceText2": d["service_text_2"],
          "ServiceText3": d["service_text_3"],
          "Total Bed Spaces": +d["beds"],
          "Website": d["URL_link"],
          "Women's service": d["women"],
          "Young people's service": d["yp"],
          "geo_code": d["service_borough"],
          "housing_subregion": d["housing_subregion"],
          "id": d["id"],
          "la_name": d["la_name"],
          "serviceType": d["service_type"]
        }));

        // Use totalsData and colorsData as is
        let totals = totalsData;
        let colors = colorsData.filter(d => d.note && isNaN(d.note));

        // Continue with your existing logic
        alert.hide();
        providers = providers.filter(d => d.Provider);
        data = processData(services, providers, totals, colors);
        console.log(services, providers, totals, colors);
        setupGroupBySelectControl();
        setupSizeBySelectControl();
        setupHighlightBySelectControl();
        setupIncludeYPSelectControl();
        renderHeader();
        renderSummary();
        renderChart();
        dispatch.call("update");
      })
      .catch((err) => {
        console.error(err);
        alert.show();
      });

    function renderSummary() {
      const container = d3
        .select("#infographic-summary")
        .classed("infographic-summary", true);

      dispatch.on("update.summary", () => {
        let highlightBy;
        switch (selected.highlightBy) {
          case "london":
            highlightBy = "all London";
            break;
          case "women":
            highlightBy = "women's services";
            break;
          case "young":
            highlightBy = "young People's services";
            break;
          default:
            break;
        }
        const d = data.totals[selected.highlightBy];
        /* html */
        container.html(`
      <div class="summary-title">Summary of services for ${highlightBy}</div>
      <div class="summary-row">
        <div class="color-square" style='background-color: ${colorByServiceType("Nightshelter_Wintershelter")}'></div>
        <div><span style='color: ${colorByServiceType("Nightshelter_Wintershelter")}'>${formatCount(d.shelterspaces)}</span> spaces in Winter Shelters</div>
      </div>
      <div class="summary-row">
        <div class="color-square" style='background-color: ${colorByServiceType("Housing_First")}'></div>
        <div><span style='color: ${colorByServiceType("Housing_First")}'>${formatCount(d.hfunits)}</span> Housing First units</div>
      </div>
      <div class="summary-row">
        <div class="color-square" style='background-color: ${colorByServiceType("Outreach")}'></div>
        <div><span style='color: ${colorByServiceType("Outreach")}'>Outreach</span> ${d.outreach}</div>
      </div>
      <div class="summary-row">
        <div class="color-square" style='background-color: ${colorByServiceType("Assessment_Centre")}'></div>
        <div><span style='color: ${colorByServiceType("Assessment_Centre")}'>${formatCount(d.assessmentcentreservices)}</span> assessment services</div>
      </div>
      <div class="summary-row">
        <div class="color-square" style='background-color: ${colorByServiceType("Day_Centre")}'></div>
        <div><span style='color: ${colorByServiceType("Day_Centre")}'>${formatCount(d.daycentreservices)}</span> day centres</div>
      </div>
      <div class="summary-row">
        <div class="color-square" style='background-color: ${d3.color(colorByServiceType("Accommodation")).darker(0.7)}'></div>
        <div><span style='color: ${d3.color(colorByServiceType("Accommodation")).darker(0.7)}'>${formatCount(d.ypspaces)}</span> beds in <span style='color: ${d3.color(colorByServiceType("Accommodation")).darker(0.7)}'>${formatCount(d.ypservices)}</span> accommodation services for young people</div>
      </div>
      <div class="summary-row">
        <div class="color-square" style='background-color: ${colorByServiceType("Accommodation")}'></div>
        <div><span style='color: ${colorByServiceType("Accommodation")}'>${formatCount(d.accomspaces)}</span> beds in <span style='color: ${colorByServiceType("Accommodation")}'>${formatCount(d.accomservices)}</span> rough sleeping/single homeless accommodation services</div>
      </div>
    `);
      });
    }

    // Chart
    function renderChart() {
      let svgWidth, width;
      let svg;

      const labelColWidth = {
        borough: 240,
        provider: 340,
      };
      const svgHeight = 14;
      const margin = {
        top: 0,
        right: 1,
        bottom: 1,
        left: 0,
      };
      const height = svgHeight - margin.top - margin.bottom;

      const x = d3.scaleLinear();

      const container = d3
        .select("#infographic-chart")
        .classed("infographic-chart", true);

      const headerRow = container
        .append("div")
        .attr("class", "infographic-chart-header row");
      const unit = headerRow
        .append("div")
        .attr(
          "class",
          "infographic-chart-header-unit label-col col-auto text-right"
        );
      const blocksContainer = headerRow
        .append("div")
        .attr("class", "col-12 col-md blocks-col")
        .append("div");

      const chartRows = container.append("div");

      const panLondonContainer = container
        .append("div")
        .attr("class", "pan-london-container")
        .call((div) =>
          div
            .append("div")
            .attr("class", "pan-london-label mb-1")
            .text("Pan-London Services")
        )
        .call((div) =>
          div
            .append("svg")
            .attr("class", "pan-london-svg")
            .each(function () {
              const box = this.getBoundingClientRect();
              d3.select(this).attr("width", box.width).attr("height", box.height);
            })
            .call((svg) =>
              svg
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`)
            )
        );

      updateDimension();
      updateInstructionText();

      dispatch.on("update", update);
      window.addEventListener("resize", resize);
      window.addEventListener("resize", updateInstructionText);

      function updateDimension() {
        unit.style("width", `${labelColWidth[selected.groupBy]}px`);
        svgWidth = blocksContainer.node().clientWidth;
        width = svgWidth - margin.left - margin.right;
        x.range([0, width]);
      }

      function update() {
        updateDimension();
        unit.text(`Number of ${selected.sizeBy}s`);

        const transition = d3.transition().duration(TRANSITION_DURATION);

        // Get the raw data
        let rowsData = data.services[selected.groupBy][selected.sizeBy];

        // Filter the items within each row based on YP selection
        rowsData = rowsData.map(row => ({
          ...row,
          items: row.items.filter(d => selected.includeYP === "yes" || !d["Young people's service"]),
          total: {
            service: row.items.filter(d => selected.includeYP === "yes" || !d["Young people's service"]).length,
            bed: d3.sum(row.items.filter(d => selected.includeYP === "yes" || !d["Young people's service"]), accessor.services.beds)
          }
        }));

        // Filter out empty rows
        rowsData = rowsData.filter(row => row.items.length > 0);

        // Re-sort the data based on the current view
        const isMobile = window.innerWidth <= 768;
        const sortBy = isMobile ? 'service' : selected.sizeBy; // Always sort by service count on mobile

        if (selected.groupBy === "borough") {
          // Sort boroughs (excluding Pan-London which we'll add back at the end)
          const panLondonRow = rowsData.find(d => d.key === "Pan-London");
          const nonPanLondonRows = rowsData.filter(d => d.key !== "Pan-London");

          nonPanLondonRows.sort((a, b) => {
            if (sortBy === "service") {
              return d3.descending(a.total.service, b.total.service) || d3.ascending(a.key, b.key);
            } else {
              return d3.descending(a.total.bed, b.total.bed) || d3.ascending(a.key, b.key);
            }
          });

          // Reconstruct with Pan-London at the end if it exists
          rowsData = panLondonRow ? [...nonPanLondonRows, panLondonRow] : nonPanLondonRows;
        } else {
          // Sort providers
          rowsData.sort((a, b) => {
            if (sortBy === "service") {
              return d3.descending(a.total.service, b.total.service);
            } else {
              return d3.descending(a.total.bed, b.total.bed);
            }
          });
        }

        let panLondonServiceData;
        if (selected.groupBy === "borough") {
          panLondonServiceData = rowsData[rowsData.length - 1];
          rowsData = rowsData.slice(0, -1);
        }

        x.domain([0, d3.max(rowsData, (d) => d.total[selected.sizeBy])]);

        const chartRow = chartRows
          .selectAll(".infographic-chart-row")
          .data(rowsData, (d) => d.key)
          .join((enter) =>
            enter
              .append("div")
              .attr("class", "infographic-chart-row row align-items-center mb-1")
              .call((div) =>
                div
                  .append("div")
                  .attr(
                    "class",
                    "label-col col-auto d-flex justify-content-between"
                  )
                  .call((div) => div.append("span").attr("class", "row-name"))
                  .call((div) => div.append("span").attr("class", "row-total"))
              )
              .call((div) =>
                div
                  .append("div")
                  .attr("class", "blocks-col col-12 col-md")
                  .append("svg")
                  .attr("class", "blocks-svg")
                  .attr("height", svgHeight)
                  .append("g")
                  .attr("transform", `translate(${margin.left},${margin.top})`)
              )
          )

        chartRow
          .call((div) =>
            div
              .select(".label-col")
              .style("width", `${labelColWidth[selected.groupBy]}px`)
          )
          .call((div) => div.select(".row-name").text((d) => d.key))
          .call((div) =>
            div
              .select(".row-total")
              .text((d) => {
                // On mobile, always show service count even in bed mode
                const countType = isMobile ? 'service' : selected.sizeBy;
                return formatCount(d.total[countType]);
              })
          );

        if (isMobile) {
          // Mobile: grid layout with fixed number of columns, using sorted/stacked data
          const cols = 12;
          const mobileWidth = svgWidth - 50; // Account for padding/margins

          svg = chartRow.select(".blocks-svg")
            .attr("width", mobileWidth)
            .each(function() {
              const rowData = d3.select(this.parentNode).datum();
              const sortedItems = stack(rowData.items);
              const totalBlocks = sortedItems.length;
              const rows = Math.ceil(totalBlocks / cols);
              const cellSize = mobileWidth / cols;

              d3.select(this).attr("height", rows * cellSize);
            });

          svg
            .select("g")
            .selectAll(".block")
            .data((d) => stack(d.items), accessor.services.id)
            .join((enter) =>
              enter
                .append("rect")
                .attr("class", "block")
                .attr("fill", blockColor)
                .on("mouseenter", entered)
                .on("mouseleave", left)
                .on("mousemove", moved)
                .on("click", (d) => clicked(d))
            )
            .attr("x", (d, i) => (i % cols) * (mobileWidth / cols))
            .attr("y", (d, i) => Math.floor(i / cols) * (mobileWidth / cols))
            .attr("width", mobileWidth / cols - 1)
            .attr("height", mobileWidth / cols - 1)
            .attr("fill", blockColor);
        } else {
          // Desktop: horizontal bar layout (original working code)
          // Calculate width from the actual blocks column container
          svg = chartRow.select(".blocks-svg").each(function() {
            const actualWidth = this.parentNode.clientWidth;
            if (actualWidth > 0) {
              svgWidth = actualWidth;
              width = svgWidth - margin.left - margin.right;
              x.range([0, width]);
              d3.select(this).attr("width", actualWidth);
            }
          });

          svg
            .select("g")
            .selectAll(".block")
            .data((d) => stack(d.items), accessor.services.id)
            .join((enter) =>
              enter
                .append("rect")
                .attr("class", "block")
                .attr("height", height)
                .attr("width", 0)
                .attr("x", (d) => x(0))
                .attr("fill", blockColor)
                .on("mouseenter", entered)
                .on("mouseleave", left)
                .on("mousemove", moved)
                .on("click", (d) => clicked(d))
            )
            .transition(transition)
            .attr("width", (d) => Math.max(0, x(d.stack[1]) - x(d.stack[0])))
            .attr("x", (d) => x(d.stack[0]))
            .attr("fill", blockColor);
        }

        if (selected.groupBy === "borough") {
          panLondonContainer.classed("d-none", false);
          const svg = panLondonContainer.select(".pan-london-svg");
          const width = +svg.attr("width") - margin.left - margin.right;
          const height = +svg.attr("height") - margin.top - margin.bottom;

          // Clear existing elements when switching between views to avoid data structure conflicts
          svg.select("g").selectAll(".block").remove();

          if (selected.sizeBy === "service") {
            // Grid layout for equal-sized services
            const items = panLondonServiceData.items
              .filter(d => selected.includeYP === "yes" || !d["Young people's service"])
              .map((d) => Object.assign({}, d));

            // Sort items by service type to group colors together
            const serviceTypes = [
              "Clearing_House",
              "Nightshelter_Wintershelter",
              "Housing_First",
              "Outreach",
              "Assessment_Centre",
              "Day_Centre",
              "Accommodation",
            ];

            items.sort((a, b) => {
              // First sort by service type
              const aTypeIndex = serviceTypes.indexOf(accessor.services.serviceType(a));
              const bTypeIndex = serviceTypes.indexOf(accessor.services.serviceType(b));

              if (aTypeIndex !== bTypeIndex) {
                return aTypeIndex - bTypeIndex;
              }

              // Within same service type, put young people's accommodation first
              if (accessor.services.serviceType(a) === "Accommodation" &&
                accessor.services.serviceType(b) === "Accommodation") {
                return d3.descending(a["Young people's service"], b["Young people's service"]);
              }

              return 0;
            });

            const count = items.length;
            // Use 12 columns on mobile, square grid on desktop
            const cols = isMobile ? 12 : Math.ceil(Math.sqrt(count));
            const rows = Math.ceil(count / cols);
            const panLondonWidth = isMobile ? (svgWidth - 100) : width;
            const cellSize = isMobile ? (panLondonWidth / cols) : Math.min(width / cols, height / rows);

            // Update SVG dimensions for mobile
            if (isMobile) {
              svg.attr("width", panLondonWidth).attr("height", rows * cellSize);
            }

            svg
              .select("g")
              .selectAll(".block")
              .data(items)  // Remove key function
              .join((enter) =>
                enter
                  .append("rect")
                  .attr("class", "block")
                  .attr("fill", blockColor)
                  .attr("x", (d, i) => (i % cols) * cellSize)
                  .attr("y", (d, i) => Math.floor(i / cols) * cellSize)
                  .attr("width", cellSize - 1)
                  .attr("height", cellSize - 1)
                  .on("mouseenter", function (d) {
                    entered.call(this, d);
                  })
                  .on("mouseleave", left)
                  .on("mousemove", moved)
                  .on("click", clicked)
              )
              .transition(transition)
              .attr("x", (d, i) => (i % cols) * cellSize)
              .attr("y", (d, i) => Math.floor(i / cols) * cellSize)
              .attr("width", cellSize - 1)
              .attr("height", cellSize - 1)
              .attr("fill", blockColor);
          } else {
            // Keep existing treemap logic for bed-sized view
            const items = panLondonServiceData.items
              .filter(d => selected.includeYP === "yes" || !d["Young people's service"])
              .map((d) => Object.assign({}, d));

            let root = {
              children: items,
            };
            root = d3
              .hierarchy(root)
              .sum((d) => accessor.services.beds(d))
              .sort((a, b) => b.value - a.value);

            d3.treemap().size([width, height]).round(true).tile(d3.treemapBinary)(root);

            svg
              .select("g")
              .selectAll(".block")
              .data(root.leaves())  // Remove key function
              .join((enter) =>
                enter
                  .append("rect")
                  .attr("class", "block")
                  .attr("fill", (d) => blockColor(d.data))
                  .attr("x", (d) => d.x0)
                  .attr("y", (d) => d.y0)
                  .attr("width", (d) => d.x1 - d.x0)
                  .attr("height", (d) => d.y1 - d.y0)
                  .on("mouseenter", function (d) {
                    entered.call(this, d.data);
                  })
                  .on("mouseleave", (d) => left(d.data))
                  .on("mousemove", (d) => moved(d.data))
                  .on("click", (d) => clicked(d.data))
              )
              .transition(transition)
              .attr("x", (d) => d.x0)
              .attr("y", (d) => d.y0)
              .attr("width", (d) => d.x1 - d.x0)
              .attr("height", (d) => d.y1 - d.y0)
              .attr("fill", (d) => blockColor(d.data));
          }
        } else {
          panLondonContainer.classed("d-none", true);
        }
      }

      function entered(d) {
        const isMobile = window.innerWidth <= 768;
        if (isMobile) return; // On mobile, only respond to clicks
        d3.select(this).raise();
        tooltip.show(blockTooltipContent(d), blockColor(d), accessor.services.website(d));
      }

      function left() {
        const isMobile = window.innerWidth <= 768;
        if (isMobile) return; // On mobile, tooltip stays until X is clicked
        tooltip.hide();
      }

      function moved() {
        tooltip.move();
      }

      function clicked(d) {
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
          // On mobile, first click shows tooltip with close button and link
          d3.select(this).raise();
          tooltip.show(blockTooltipContent(d), blockColor(d), accessor.services.website(d));

          // Center the tooltip on mobile
          const tooltipNode = document.querySelector('.chart-tooltip');
          const bcr = tooltipNode.getBoundingClientRect();
          const x = (window.innerWidth - bcr.width) / 2;
          const y = (window.innerHeight - bcr.height) / 2;
          tooltipNode.style.transform = `translate(${x}px,${y}px)`;
        } else {
          // On desktop, click opens website
          console.log(accessor.services.website(d))
          if (accessor.services.website(d) === "") return;
          window.open(accessor.services.website(d), "_blank");
        }
      }


      function resize() {
        updateDimension();
        const isMobile = window.innerWidth <= 768;

        if (isMobile) {
          // Mobile: update grid layout
          const cols = 12;
          const mobileWidth = svgWidth - 100;

          svg.attr("width", mobileWidth).selectAll(".block").each(function(d, i, nodes) {
            const rowData = d3.select(nodes[i].parentNode).datum();
            const totalBlocks = rowData.items.length;
            const rows = Math.ceil(totalBlocks / cols);
            const cellSize = mobileWidth / cols;

            d3.select(this)
              .attr("x", (i % cols) * cellSize)
              .attr("y", Math.floor(i / cols) * cellSize)
              .attr("width", cellSize - 1)
              .attr("height", cellSize - 1);

            d3.select(nodes[i].parentNode.parentNode)
              .attr("height", rows * cellSize);
          });
        } else {
          // Desktop: update horizontal bar layout
          svg
            .attr("width", svgWidth)
            .selectAll(".block")
            .attr("width", (d) => Math.max(0, x(d.stack[1]) - x(d.stack[0])))
            .attr("x", (d) => x(d.stack[0]));
        }
      }

      function blockColor(d) {
        let highlightResult = accessor.services.highlight[selected.highlightBy](d);

        if (highlightResult) {
          if (selected.sizeBy === "service") {
            let color = colorByServiceType(accessor.services.serviceType(d));
            // Special case for young people's accommodation
            if (accessor.services.serviceType(d) === "Accommodation" &&
              d["Young people's service"]) {  // Direct property access
              return d3.color(color).darker(0.7);
            }
            return color;
          } else {
            let color = colorByServiceType("Accommodation");
            // Special case for young people's accommodation in bed view
            if (d["Young people's service"]) {  // Direct property access
              return d3.color(color).darker(0.7);
            }
            return color;
          }
        } else {
          return "#D3D3D3";
        }
      }

      const serviceTypes = [
        "Clearing_House",
        "Nightshelter_Wintershelter",
        "Housing_First",
        "Outreach",
        "Assessment_Centre",
        "Day_Centre",
        "Accommodation",
      ];

      function stack(items) {
        let stacked = items.map((d) => Object.assign({}, d));
        let acc = 0;
        switch (selected.sizeBy) {
          case "service":
            stacked.sort((a, b) => {
              // First sort by highlight status
              let highlightDiff = d3.descending(
                accessor.services.highlight[selected.highlightBy](a),
                accessor.services.highlight[selected.highlightBy](b)
              );
              if (highlightDiff !== 0) return highlightDiff;

              // Then sort by service type with special handling for young people's accommodation
              let aType = accessor.services.serviceType(a);
              let bType = accessor.services.serviceType(b);

              // If both are accommodation, put young people's services first
              if (aType === "Accommodation" && bType === "Accommodation") {
                return d3.descending(a["Young people's service"], b["Young people's service"]);
              }

              // Otherwise use the standard service type ordering
              return d3.ascending(
                serviceTypes.indexOf(aType),
                serviceTypes.indexOf(bType)
              );
            });
            stacked.forEach((d) => (d.stack = [acc, ++acc]));
            break;

          case "bed":
            stacked.sort((a, b) => {
              // First sort by highlight status
              let highlightDiff = d3.descending(
                accessor.services.highlight[selected.highlightBy](a),
                accessor.services.highlight[selected.highlightBy](b)
              );
              if (highlightDiff !== 0) return highlightDiff;

              // For bed view, sort young people's accommodation first within same bed count
              if (accessor.services.beds(a) === accessor.services.beds(b)) {
                return d3.descending(a["Young people's service"], b["Young people's service"]);
              }

              // Otherwise sort by bed count
              return d3.descending(accessor.services.beds(a), accessor.services.beds(b));
            });
            stacked.forEach((d) => (d.stack = [acc, (acc += accessor.services.beds(d))]));
            break;
        }
        return stacked;
      }
    }

    // Controls
    function setupGroupBySelectControl() {
      d3.select("#group-by-select").on("change", function () {
        selected.groupBy = this.value;
        dispatch.call("update");
      });
    }

    function setupSizeBySelectControl() {
      d3.select("#size-by-select").on("change", function () {
        selected.sizeBy = this.value;
        dispatch.call("update");
      });
    }

    function setupHighlightBySelectControl() {
      d3.select("#highlight-by-select").on("change", function () {
        selected.highlightBy = this.value;
        dispatch.call("update");
      });
    }

    function setupIncludeYPSelectControl() {
      d3.select("#include-yp-select").on("change", function () {
        selected.includeYP = this.value;
        dispatch.call("update");
      });
    }

    // Header
    function renderHeader() {
      const headerMainTitle = d3.select(".chart-title-main");
      dispatch.on("update.header", () => {
        let title = "";

        switch (selected.sizeBy) {
          case "service":
            title += "Services";
            break;
          case "bed":
            title += "Accommodation (hostel/supported) by bed spaces";
            break;
          default:
            break;
        }

        title += " for each ";

        switch (selected.groupBy) {
          case "borough":
            title += "borough";
            break;
          case "provider":
            title += "provider";
            break;
          default:
            break;
        }

        headerMainTitle.text(title);
      });
    }

    // Process data
    function processData(services, providers, totals, colors) {
      const data = {};

      data.colors = colors.filter(accessor.colors.infographicRelated);
      colorByServiceType
        .domain(data.colors.map(accessor.colors.serviceType))
        .range(data.colors.map(accessor.colors.color));
      serviceTypeByRecordTypeId
        .domain(data.colors.map(accessor.colors.recordTypeId))
        .range(data.colors.map(accessor.colors.serviceType));
      const serviceTypeMap = {
        "Night Shelter or Winter Shelter": "Nightshelter_Wintershelter",
        "Housing First": "Housing_First",
        "Outreach": "Outreach",
        "Assessment Centre": "Assessment_Centre",
        "Day Centre": "Day_Centre",
        "Accommodation": "Accommodation"
      }

      const validServiceTypes = Object.values(serviceTypeMap);

      services.forEach((d, i) => {
        d.id = i;
        d.serviceType = serviceTypeMap[d.serviceType];
      });
      providers.forEach((d, i) => {
        d.id = i;
        d.serviceType = serviceTypeByRecordTypeId(d["Record Type ID"]);
      });

      const servicesByBoroughSortedByService = (() => {
        servicesByBorough = d3.groups(
          // Filter services based on the values in validServiceTypes
          services.filter(d => validServiceTypes.includes(d.serviceType))
            .filter(d => selected.includeYP === "yes" || !d["Young people's service"]),  // Add this line
          accessor.services.borough
        )
          .map(([key, value]) => ({
            key,
            total: {
              service: value.length,
              bed: d3.sum(value, accessor.services.beds),
            },
            items: value,
          }));
        const panLondonService = servicesByBorough.find(
          (d) => d.key === "Pan-London"
        );
        const nonPanLondServices = servicesByBorough.filter(
          (d) => d.key !== "Pan-London"
        );
        return [
          ...nonPanLondServices.sort(
            (a, b) =>
              d3.descending(a.total.service, b.total.service) ||
              d3.ascending(a.key, b.key)
          ),
          panLondonService,
        ];
      })();

      const servicesByBoroughSortedByBed = (() => {
        servicesByBorough = d3
          .groups(
            services.filter(
              (d) => accessor.services.serviceType(d) === "Accommodation"
            )
              .filter(d => selected.includeYP === "yes" || !d["Young people's service"]),  // Add this line
            accessor.services.borough
          )
          .map(([key, value]) => ({
            key,
            total: {
              service: value.length,
              bed: d3.sum(value, accessor.services.beds),
            },
            items: value,
          }));
        const panLondonService = servicesByBorough.find(
          (d) => d.key === "Pan-London"
        );
        const nonPanLondServices = servicesByBorough.filter(
          (d) => d.key !== "Pan-London"
        );
        return [
          ...nonPanLondServices.sort(
            (a, b) =>
              d3.descending(a.total.bed, b.total.bed) ||
              d3.ascending(a.key, b.key)
          ),
          panLondonService,
        ];
      })();

      const servicesByProviderSortedByService = (() => {
        d3.group(
          providers.filter(
            d => validServiceTypes.includes(accessor.services.serviceType(d))
          )
            .filter(d => selected.includeYP === "yes" || !d["Young people's service"]),  // Add this line
          accessor.services.providerName
        ).forEach((value, key) => {
          if (value.length === 1) {
            // For providers with exactly 1 service
            value.forEach(
              (d) => (d.providerGroupService = "PROVIDERS WITH 1 SERVICE")
            );
          } else if (value.length === 2) {
            // For providers with exactly 2 services
            value.forEach(
              (d) => (d.providerGroupService = "PROVIDERS WITH 2 SERVICES")
            );
          } else {
            // For providers with more than 2 services, handle as needed
            value.forEach(
              (d) => (d.providerGroupService = accessor.services.providerName(d))
            );
          }
        });


        const servicesByProvider = d3.groups(
          providers.filter(
            d => validServiceTypes.includes(accessor.services.serviceType(d))
          ),
          accessor.services.providerGroup.service
        )
          .map(([key, value]) => ({
            key,
            total: {
              service: value.length,
              bed: d3.sum(value, accessor.services.beds),
            },
            items: value,
          }));
        return servicesByProvider.sort((a, b) =>
          d3.descending(a.total.service, b.total.service)
        );
      })();

      const servicesByProviderSortedByBed = (() => {
        d3.group(
          providers.filter(
            (d) => accessor.services.recordTypeId(d) === "012A00000012r8gIAA"
          )
            .filter(d => selected.includeYP === "yes" || !d["Young people's service"]),  // Add this line
          accessor.services.providerName
        ).forEach((value, key) => {
          if (value.length === 1) {
            // For providers with exactly 1 service
            value.forEach(
              (d) => (d.providerGroupBed = "PROVIDERS WITH 1 SERVICE")
            );
          } else if (value.length === 2) {
            // For providers with exactly 2 services
            value.forEach(
              (d) => (d.providerGroupBed = "PROVIDERS WITH 2 SERVICES")
            );
          } else {
            // For providers with more than 2 services, handle as needed
            value.forEach(
              (d) => (d.providerGroupBed = accessor.services.providerName(d))
            );
          }
        });

        const servicesByProvider = d3
          .groups(
            providers.filter(
              (d) => accessor.services.recordTypeId(d) === "012A00000012r8gIAA"
            ),
            accessor.services.providerGroup.bed
          )
          .map(([key, value]) => ({
            key,
            total: {
              service: value.length,
              bed: d3.sum(value, accessor.services.beds),
            },
            items: value,
          }));
        return servicesByProvider.sort((a, b) =>
          d3.descending(a.total.bed, b.total.bed)
        );
      })();

      data.services = {
        borough: {
          service: servicesByBoroughSortedByService,
          bed: servicesByBoroughSortedByBed,
        },
        provider: {
          service: servicesByProviderSortedByService,
          bed: servicesByProviderSortedByBed,
        },
      };

      data.totals = [
        { key: "london", longKey: "LONDON" },
        { key: "women", longKey: "Women's services" },
        { key: "young", longKey: "Young People's services" },
      ].reduce((acc, cur) => {
        const total = totals.find((d) => accessor.totals.key(d) === cur.longKey);
        acc[cur.key] = total;
        return acc;
      }, {});

      Object.keys(data.totals).forEach((key) => {
        const d = data.totals[key];
        switch (key) {
          case "london":
            d.chflats = 3800;
            d.outreach = "commissioned by individual boroughs and the GLA";
            break;
          case "women":
            d.chflats = 0;
            d.outreach = "provided through standard services";
            break;
          case "young":
            d.chflats = 0;
            d.outreach = "provided through standard services";
            break;
          default:
            break;
        }
      });

      return data;
    }

    // Tooltip
    function renderTooltip(tooltip) {
      let width, height;
      const padding = 8;
      const isMobile = window.innerWidth <= 768;

      function show(content, color, websiteUrl) {
        if (isMobile) {
          const closeBtn = '<button class="tooltip-close" data-close-tooltip>&times;</button>';
          const link = websiteUrl && websiteUrl !== "" ? `<div class="tooltip-link" onclick="window.open('${websiteUrl}', '_blank')">Visit website</div>` : '';
          tooltip.style("border-color", color).html(closeBtn + content + link);

          // Add click handler for close button
          tooltip.select('.tooltip-close').on('click', function() {
            hide();
          });
        } else {
          tooltip.style("border-color", color).html(content);
        }
        const bcr = tooltip.node().getBoundingClientRect();
        width = bcr.width;
        height = bcr.height;
        tooltip.classed("show", true);
      }

      function hide() {
        tooltip.classed("show", false);
      }

      function move() {
        if (isMobile) return;
        let x = d3.event.clientX - width / 2;
        if (x < 0) {
          x = 0;
        } else if (x + width > window.innerWidth) {
          x = window.innerWidth - width;
        }
        let y = d3.event.clientY - height - padding;
        if (y < 0) {
          y = 0;
        }
        tooltip.style("transform", `translate(${x}px,${y}px)`);
      }

      return {
        show,
        hide,
        move,
      };
    }

    function blockTooltipContent(d, color) {
      const texts = accessor.services.text(d);
      const capacity = texts[0];
      const isMobile = window.innerWidth <= 768;
      return `
        <p class="service-name">${accessor.services.serviceName(d)}</p>
        <p>${accessor.services
          .serviceType(d)
          .replace("_", " ")} - Provided in <span>${accessor.services.borough(
            d
          )}</span> by <span>${accessor.services.providerName(d)}</span></p>
        ${texts
          .filter((e) => e)
          .map(
            (e) =>
              `<p ${e == capacity ? `class="service-capacity"` : ""}>${e}</p>`
          )
          .join("")}
        ${!isMobile ? '<p><em>Click to view site</em></p>' : ''}
    `;
    }

    // Alert
    function setupAlert() {
      const alert = d3.select(".alert-danger");
      function show() {
        alert.classed("d-none", false);
      }
      function hide() {
        alert.classed("d-none", true);
      }
      return {
        show,
        hide,
      };
    }

    // Is touch
    // https://github.com/airbnb/is-touch-device/blob/master/src/index.js
    function isTouchDevice() {
      return (
        !!(
          typeof window !== "undefined" &&
          ("ontouchstart" in window ||
            (window.DocumentTouch &&
              typeof document !== "undefined" &&
              document instanceof window.DocumentTouch))
        ) ||
        !!(
          typeof navigator !== "undefined" &&
          (navigator.maxTouchPoints || navigator.msMaxTouchPoints)
        )
      );
    }
  })();


</script>
<script>
  (function () {
    const CSV_LINKS_URL = "https://www.illustrate.studio/sites/default/files/json/csv_links_20220908.json";

    const modalWidth = 320;

    d3.json(CSV_LINKS_URL).then((csvLinks) => {
      const modal = d3
        .select("body")
        .append("div")
        .attr("class", "modal fade")
        .attr("id", "csv-modal")
        .attr("tabindex", "-1");

      const modalDialog = modal
        .append("div")
        .attr("class", "modal-dialog m-0")
        .style("width", `${modalWidth}px`);

      const modalContent = modalDialog
        .append("div")
        .attr("class", "modal-content");

      const modalHeader = modalContent
        .append("div")
        .attr("class", "modal-header")
        .call((header) =>
          header.append("h6").attr("class", "modal-title").text("CSV Download")
        )
        .call((header) =>
          header
            .append("button")
            .attr("type", "button")
            .attr("class", "close")
            .attr("data-dismiss", "modal")
            .attr("aria-label", "Close")
            .append("span")
            .attr("aria-hidden", "true")
            .html("&times;")
        );

      const form = modalContent
        .append("div")
        .attr("class", "modal-body")
        .append("form");
      form
        .append("div")
        .attr("class", "form-group")
        .call((group) =>
          group
            .append("label")
            .attr("for", "csv-source-select")
            .text("Which data source would you like to download?")
        )
        .call((group) =>
          group
            .append("select")
            .attr("class", "form-control custom-select-url custom-select-sm")
            .attr("id", "csv-source-select")
            .selectAll("option")
            .data(csvLinks)
            .join("option")
            .attr("value", (d) => d.url)
            .text((d) => d.name)
        );
      form
        .append("button")
        .attr("type", "submit")
        .attr("class", "btn btn-sm btn-primary")
        .text("Download")
        .on("click", downloadCSV);

      const csvButton = d3
        .select(".btn__export--csv")
        .attr("data-toggle", "modal")
        .attr("data-target", "#csv-modal");

      d3.select("body").append("style").text(`
      .modal-backdrop.show {
        opacity: 0.2;
      }
    `);

      const {
        width: buttonWidth,
        height: buttonHeight,
      } = csvButton.node().getBoundingClientRect();

      $("#csv-modal").on("show.bs.modal", positionModal);
      window.addEventListener("resize", resize);

      function downloadCSV() {
        d3.event.preventDefault();
        const url = d3.select("#csv-source-select").node().value;
        if (url) {
          window.location = url;
        }
      }

      function positionModal() {
        let { left, top } = csvButton.node().getBoundingClientRect();
        left = left + buttonWidth / 2 - modalWidth / 2;
        if (left < 0) left = 0;
        if (left + modalWidth > window.innerWidth)
          left = window.innerWidth - modalWidth;
        top = top + buttonHeight;
        modalDialog.style("left", `${left}px`).style("top", `${top}px`);
      }

      function resize() {
        if (modal.classed("show")) {
          positionModal();
        }
      }
    });
  })();
</script>
<script>window.Choices = {}</script>